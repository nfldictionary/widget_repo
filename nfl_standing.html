<script>
  const API_KEY = "네키";
  const SEASON = "2024REG";

  async function loadStandings() {
    const statusEl = document.getElementById("status");
    const tbody = document.querySelector("#table tbody");

    statusEl.textContent = "Fetching…";

    try {
      const url = `https://api.sportsdata.io/v3/nfl/scores/json/Standings/${SEASON}?key=${encodeURIComponent(API_KEY)}`;
      const res = await fetch(url, { headers: { "Accept": "application/json" } });

      // 응답 텍스트 먼저 확보(에러 메시지 확인용)
      const text = await res.text();

      if (!res.ok) {
        statusEl.textContent = `HTTP ${res.status} ${res.statusText} / ${text.slice(0, 180)}`;
        return;
      }

      const data = JSON.parse(text);

      if (!Array.isArray(data)) {
        statusEl.textContent = `Unexpected response (not array): ${text.slice(0, 180)}`;
        return;
      }

      data.sort((a, b) => (b.Percentage ?? 0) - (a.Percentage ?? 0));

      tbody.innerHTML = "";
      data.forEach((team, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td class="team">${team.City ?? ""} ${team.Name ?? team.Team ?? ""}</td>
          <td>${team.Wins ?? "-"}</td>
          <td>${team.Losses ?? "-"}</td>
          <td>${team.Ties ?? "-"}</td>
          <td>${(team.Percentage ?? 0).toFixed ? (team.Percentage).toFixed(3) : "-"}</td>
        `;
        tbody.appendChild(tr);
      });

      statusEl.textContent = "Updated";
    } catch (e) {
      // 여기서 "TypeError: Failed to fetch"면 CORS 가능성 큼
      statusEl.textContent = `Fetch error: ${String(e)}`;
      console.error(e);
    }
  }

  loadStandings();
</script>
